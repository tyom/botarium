/**
 * AI Streaming utilities with error handling
 */
import { streamText } from 'ai'
import type { LanguageModelV3 } from '@ai-sdk/provider'
import { slackLogger } from '../utils/logger'
import { isAuthError, isRateLimitError, isQuotaError } from './error'

export interface StreamOptions {
  model: LanguageModelV3
  system?: string
  messages: Array<{ role: 'user' | 'assistant'; content: string }>
}

/**
 * Stream AI response with proper error handling.
 * Validates API key if stream returns no content.
 */
export async function* streamAIResponse(
  options: StreamOptions
): AsyncIterable<string> {
  const { model, system, messages } = options

  slackLogger.debug(
    { provider: model.provider, model: model.modelId },
    'Starting AI stream'
  )

  const result = streamText({
    model,
    system,
    messages,
  })

  // Stream chunks immediately and track errors
  let hasYieldedChunks = false
  let streamError: Error | null = null

  try {
    for await (const chunk of result.textStream) {
      hasYieldedChunks = true
      yield chunk
    }
  } catch (error) {
    streamError = error as Error
    slackLogger.error(
      { error: (error as Error).message, stack: (error as Error).stack },
      'AI stream error'
    )
  }

  // Check for errors even if stream appeared to succeed
  if (!hasYieldedChunks && !streamError) {
    slackLogger.error(
      { provider: model.provider, modelId: model.modelId },
      'AI stream returned no chunks - likely API key issue'
    )
    // Set a generic error so user knows something went wrong
    streamError = new Error(
      'No response from AI provider. Check your API key configuration.'
    )
  }

  // Handle any error with user-friendly messages
  if (streamError) {
    if (isAuthError(streamError)) {
      slackLogger.error({ provider: model.provider }, 'Invalid API key')
      throw new Error('Invalid API key. Please check your API key in Settings.')
    }
    if (isRateLimitError(streamError)) {
      slackLogger.error({ provider: model.provider }, 'Rate limit exceeded')
      throw new Error('Rate limit exceeded. Please try again in a moment.')
    }
    if (isQuotaError(streamError)) {
      slackLogger.error({ provider: model.provider }, 'Billing/quota issue')
      throw new Error('Quota exceeded. Please check your billing settings.')
    }

    slackLogger.error({ error: streamError.message }, 'AI error')
    throw streamError
  }
}
