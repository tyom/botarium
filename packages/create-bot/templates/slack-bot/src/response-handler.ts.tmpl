/**
 * Response Handler
 *
 * This is the main file to customize bot responses.
 */
{{#if isAi}}
import { getModel } from './settings'
import { streamAIResponse } from './ai/stream'
{{/if}}
{{#if isDb}}
import { buildMemoryContext } from './memory'
import { getPreferences, buildPreferencesContext } from './preferences'
{{/if}}

export interface ThreadContext {
  channelId: string
  threadTs: string
  userId: string
  teamId: string
  history: Array<{ role: 'user' | 'assistant'; content: string }>
}

export interface SuggestedPrompt {
  title: string
  message: string
}

export interface ResponseHandler {
  generateResponse(
    message: string,
    context: ThreadContext
  ): AsyncIterable<string>
  systemPrompt?: string
  suggestedPrompts?: SuggestedPrompt[]
}
{{#if isDb}}

async function buildEnhancedSystemPrompt(basePrompt: string, context: ThreadContext): Promise<string> {
  const [memoryContext, preferences] = await Promise.all([
    buildMemoryContext({ userId: context.userId, teamId: context.teamId }),
    getPreferences({ userId: context.userId, teamId: context.teamId }),
  ])
  const preferencesContext = buildPreferencesContext(preferences)
  return [basePrompt, memoryContext, preferencesContext].filter(Boolean).join('\n\n')
}
{{/if}}

export const responseHandler: ResponseHandler = {
  systemPrompt: '{{#if isAi}}You are a helpful assistant. Be concise and friendly.{{else}}You are a helpful assistant.{{/if}}',

  suggestedPrompts: [
    { title: 'Say hello', message: 'Hello!' },
    { title: 'Get help', message: 'What can you help me with?' },
  ],

  async *generateResponse(message, context) {
    // Handle ping command
    if (message.toLowerCase() === 'ping') {
      yield 'pong'
      return
    }
{{#if isAi}}

    // Build messages from history
    const messages = context.history
      .filter(m => m.content.trim())
      .map(m => ({
        role: m.role as 'user' | 'assistant',
        content: m.content,
      }))

    // Add current message
    messages.push({ role: 'user', content: message })
{{#if isDb}}

    // Build enhanced system prompt with memory and preferences
    const systemPrompt = await buildEnhancedSystemPrompt(this.systemPrompt ?? '', context)
{{/if}}

    // Stream response from AI
    yield* streamAIResponse({
      model: getModel(),
      system: {{#if isDb}}systemPrompt{{else}}this.systemPrompt{{/if}},
      messages,
    })
{{else}}

    // Echo response - replace with your logic
    yield `You said: ${message}`
{{/if}}
  },
}
