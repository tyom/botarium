import { z } from 'zod'
{{#if isOpenai}}
import { openai } from '@ai-sdk/openai'
{{/if}}
{{#if isAnthropic}}
import { anthropic } from '@ai-sdk/anthropic'
{{/if}}
{{#if isGoogle}}
import { google } from '@ai-sdk/google'
{{/if}}
{{#if isOpenrouter}}
import { createOpenRouter } from '@openrouter/ai-sdk-provider'
{{/if}}

// Local simulator mode (SLACK_API_URL set)
export const isSimulatorMode = Boolean(process.env.SLACK_API_URL)

const envSchema = z.object({
  // Bot Configuration
  BOT_NAME: z.string().default('{{botName}}'),
  BOT_PERSONALITY: z.string().default('Helpful AI assistant'),

  // Slack Configuration (optional in local simulator mode)
  SLACK_BOT_TOKEN: isSimulatorMode
    ? z.string().default('xoxb-local')
    : z.string().startsWith('xoxb-'),
  SLACK_APP_TOKEN: isSimulatorMode
    ? z.string().default('xapp-local')
    : z.string().startsWith('xapp-'),
  SLACK_SIGNING_SECRET: isSimulatorMode
    ? z.string().default('local')
    : z.string().min(1),
{{#if isAi}}

  // AI Configuration
  MODEL_DEFAULT: z.string().optional(),
{{#if isOpenai}}
  OPENAI_API_KEY: isSimulatorMode
    ? z.string().optional()
    : z.string().min(1, 'OpenAI API key is required'),
{{/if}}
{{#if isAnthropic}}
  ANTHROPIC_API_KEY: isSimulatorMode
    ? z.string().optional()
    : z.string().min(1, 'Anthropic API key is required'),
{{/if}}
{{#if isGoogle}}
  GOOGLE_API_KEY: isSimulatorMode
    ? z.string().optional()
    : z.string().min(1, 'Google API key is required'),
{{/if}}
{{#if isOpenrouter}}
  OPENROUTER_API_KEY: isSimulatorMode
    ? z.string().optional()
    : z.string().min(1, 'OpenRouter API key is required'),
{{/if}}
{{/if}}

  // Server
  PORT: z.coerce.number().default(3000),
  LOG_LEVEL: z.enum(['silent', 'debug', 'info', 'warn', 'error']).default('info'),
})

export type Settings = z.infer<typeof envSchema>
{{#if isAi}}

/**
 * Fetch settings from simulator emulator (when running in simulator mode)
 * The emulator receives settings from Electron and exposes them via HTTP
 */
async function fetchSimulatorSettings(): Promise<Record<string, string>> {
  if (!isSimulatorMode) return {}

  const slackApiUrl = process.env.SLACK_API_URL
  if (!slackApiUrl) return {}

  // Extract base URL (remove /api suffix if present)
  const baseUrl = slackApiUrl.replace(/\/api\/?$/, '')

  try {
    const response = await fetch(`${baseUrl}/api/simulator/settings`)
    if (response.ok) {
      const data = await response.json() as { ok: boolean; settings?: Record<string, string> }
      return data.settings ?? {}
    }
  } catch {
    // Emulator not available, use env vars only
  }

  return {}
}

async function loadSettings(): Promise<Settings> {
  // In simulator mode, fetch settings from emulator and merge with env
  const simulatorSettings = await fetchSimulatorSettings()

  // Merge: env vars take precedence over simulator settings
  const mergedEnv = { ...simulatorSettings, ...process.env }

  const result = envSchema.safeParse(mergedEnv)

  if (!result.success) {
    console.error('Invalid environment configuration:')
    for (const issue of result.error.issues) {
      console.error(`  ${issue.path.join('.')}: ${issue.message}`)
    }
    throw new Error('Failed to load settings. Check your environment variables.')
  }

  return result.data
}

// Use top-level await to load settings asynchronously
// Use `let` to allow hot-reloading when settings change at runtime
export let settings = await loadSettings()

/**
 * Reload settings from environment/simulator
 * Called after registration updates process.env
 */
export async function reloadSettings() {
  settings = await loadSettings()
}
{{else}}
function loadSettings(): Settings {
  const result = envSchema.safeParse(process.env)

  if (!result.success) {
    console.error('Invalid environment configuration:')
    for (const issue of result.error.issues) {
      console.error(`  ${issue.path.join('.')}: ${issue.message}`)
    }
    throw new Error('Failed to load settings. Check your environment variables.')
  }

  return result.data
}

export const settings = loadSettings()
{{/if}}
{{#if isAi}}

// AI Model helper
export function getModel() {
{{#if isOpenai}}
  return openai(settings.MODEL_DEFAULT || 'gpt-4o')
{{/if}}
{{#if isAnthropic}}
  return anthropic(settings.MODEL_DEFAULT || 'claude-sonnet-4-5')
{{/if}}
{{#if isGoogle}}
  return google(settings.MODEL_DEFAULT || 'gemini-2.0-flash')
{{/if}}
{{#if isOpenrouter}}
  const openrouter = createOpenRouter({ apiKey: settings.OPENROUTER_API_KEY })
  return openrouter(settings.MODEL_DEFAULT || 'anthropic/claude-sonnet-4')
{{/if}}
}
{{/if}}
