import { z } from 'zod'
{{#if isAi}}
import { openai } from '@ai-sdk/openai'
import { anthropic } from '@ai-sdk/anthropic'
import { google } from '@ai-sdk/google'
import { createOpenRouter } from '@openrouter/ai-sdk-provider'
{{/if}}

// Local simulator mode (SLACK_API_URL set)
export const isSimulatorMode = Boolean(process.env.SLACK_API_URL)

const envSchema = z.object({
  // Bot Configuration
  BOT_NAME: z.string().default('{{botName}}'),
  BOT_PERSONALITY: z.string().default('Helpful AI assistant'),

  // Slack Configuration (optional in local simulator mode)
  SLACK_BOT_TOKEN: isSimulatorMode
    ? z.string().default('xoxb-local')
    : z.string().startsWith('xoxb-'),
  SLACK_APP_TOKEN: isSimulatorMode
    ? z.string().default('xapp-local')
    : z.string().startsWith('xapp-'),
  SLACK_SIGNING_SECRET: isSimulatorMode
    ? z.string().default('local')
    : z.string().min(1),
{{#if isAi}}

  // AI Configuration
  AI_PROVIDER: z.enum(['openai', 'anthropic', 'google', 'openrouter']).optional(),
  MODEL_DEFAULT: z.string().optional(),
  MODEL_FAST: z.string().optional(),
  MODEL_THINKING: z.string().optional(),
  OPENAI_API_KEY: z.string().optional(),
  ANTHROPIC_API_KEY: z.string().optional(),
  GOOGLE_API_KEY: z.string().optional(),
  OPENROUTER_API_KEY: z.string().optional(),
{{/if}}

  // Server
  PORT: z.coerce.number().default(3000),
  LOG_LEVEL: z.enum(['silent', 'debug', 'info', 'warn', 'error']).default('info'),
})

export type Settings = z.infer<typeof envSchema>
{{#if isAi}}

/**
 * Fetch settings from simulator emulator (when running in simulator mode)
 * The emulator receives settings from Electron and exposes them via HTTP
 */
async function fetchSimulatorSettings(): Promise<Record<string, string>> {
  if (!isSimulatorMode) return {}

  const slackApiUrl = process.env.SLACK_API_URL
  if (!slackApiUrl) return {}

  // Extract base URL (remove /api suffix if present)
  const baseUrl = slackApiUrl.replace(/\/api\/?$/, '')

  try {
    const response = await fetch(`${baseUrl}/api/simulator/settings`)
    if (response.ok) {
      const data = await response.json() as { ok: boolean; settings?: Record<string, string> }
      return data.settings ?? {}
    }
  } catch {
    // Emulator not available, use env vars only
  }

  return {}
}

async function loadSettings(): Promise<Settings> {
  // In simulator mode, fetch settings from emulator and merge with env
  const simulatorSettings = await fetchSimulatorSettings()

  // If AI_PROVIDER is set in bot's own .env, don't use API keys from simulator
  // User explicitly chose provider via .env, so they should also set the API key via .env
  if (process.env.AI_PROVIDER) {
    delete simulatorSettings.OPENAI_API_KEY
    delete simulatorSettings.ANTHROPIC_API_KEY
    delete simulatorSettings.GOOGLE_API_KEY
    delete simulatorSettings.OPENROUTER_API_KEY
  }

  // Merge: env vars take precedence over simulator settings
  const mergedEnv = { ...simulatorSettings, ...process.env }

  const result = envSchema.safeParse(mergedEnv)

  if (!result.success) {
    console.error('Invalid environment configuration:')
    for (const issue of result.error.issues) {
      console.error(`  ${issue.path.join('.')}: ${issue.message}`)
    }
    throw new Error('Failed to load settings. Check your environment variables.')
  }

  return result.data
}

// Use top-level await to load settings asynchronously
// Use `let` to allow hot-reloading when settings change at runtime
export let settings = await loadSettings()

/**
 * Reload settings from environment/simulator
 * Called after registration updates process.env
 */
export async function reloadSettings() {
  settings = await loadSettings()
}
{{else}}
function loadSettings(): Settings {
  const result = envSchema.safeParse(process.env)

  if (!result.success) {
    console.error('Invalid environment configuration:')
    for (const issue of result.error.issues) {
      console.error(`  ${issue.path.join('.')}: ${issue.message}`)
    }
    throw new Error('Failed to load settings. Check your environment variables.')
  }

  return result.data
}

export const settings = loadSettings()
{{/if}}
{{#if isAi}}

// Default models per provider (used when MODEL_DEFAULT is not set)
// Operators can override via MODEL_DEFAULT environment variable
const DEFAULT_MODELS: Record<string, string> = {
  openai: 'gpt-5.2',
  anthropic: 'claude-sonnet-4-5',
  google: 'gemini-3.0-flash-preview',
  openrouter: 'anthropic/claude-4.5-sonnet',
}

// AI Model helper
export function getModel() {
  const provider = settings.AI_PROVIDER || 'openai'
  const modelId = settings.MODEL_DEFAULT || DEFAULT_MODELS[provider]

  if (!modelId) {
    throw new Error(`No model configured for provider "${provider}". Set MODEL_DEFAULT in your environment.`)
  }

  switch (provider) {
    case 'anthropic':
      return anthropic(modelId)
    case 'google':
      return google(modelId)
    case 'openrouter':
      return createOpenRouter({ apiKey: settings.OPENROUTER_API_KEY! })(modelId)
    case 'openai':
    default:
      return openai(modelId)
  }
}
{{/if}}
