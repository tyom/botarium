import { z } from 'zod'
{{~#if isOpenai}}
import { openai } from '@ai-sdk/openai'
{{~/if}}
{{~#if isAnthropic}}
import { anthropic } from '@ai-sdk/anthropic'
{{~/if}}
{{~#if isGoogle}}
import { google } from '@ai-sdk/google'
{{~/if}}
{{~#if isAi}}

// Model tiers - customize as needed
export const MODEL_TIERS = {
{{~#if isOpenai}}
  openai: {
    fast: ['gpt-4o-mini'],
    default: ['gpt-4o'],
  },
{{~/if}}
{{~#if isAnthropic}}
  anthropic: {
    fast: ['claude-3-5-haiku-latest'],
    default: ['claude-sonnet-4-5'],
  },
{{~/if}}
{{~#if isGoogle}}
  google: {
    fast: ['gemini-2.0-flash'],
    default: ['gemini-2.5-pro'],
  },
{{~/if}}
}

export type AIProvider = keyof typeof MODEL_TIERS
export type ModelTier = 'fast' | 'default'
{{~/if}}

// Local simulator mode (SLACK_API_URL set)
export const isSimulatorMode = Boolean(process.env.SLACK_API_URL)
const isLocalMode = isSimulatorMode

const envSchema = z.object({
  // Bot Configuration
  BOT_NAME: z.string().default('{{botName}}'),
  BOT_PERSONALITY: z.string().default('Helpful AI assistant'),

  // Slack Configuration (optional in local simulator mode)
  SLACK_BOT_TOKEN: isLocalMode
    ? z.string().default('xoxb-local')
    : z.string().startsWith('xoxb-'),
  SLACK_APP_TOKEN: isLocalMode
    ? z.string().default('xapp-local')
    : z.string().startsWith('xapp-'),
  SLACK_SIGNING_SECRET: isLocalMode
    ? z.string().default('local')
    : z.string().min(1),
{{~#if isAi}}

  // AI Provider
  AI_PROVIDER: z.enum(['{{aiProvider}}']).default('{{aiProvider}}'),
{{~#if isOpenai}}
  OPENAI_API_KEY: z.string().min(1),
{{~/if}}
{{~#if isAnthropic}}
  ANTHROPIC_API_KEY: z.string().min(1),
{{~/if}}
{{~#if isGoogle}}
  GOOGLE_API_KEY: z.string().min(1),
{{~/if}}
{{~/if}}
{{~#if isDb}}

  // Database
  DB_ADAPTER: z.enum(['{{dbAdapter}}']).default('{{dbAdapter}}'),
{{~#if isPostgres}}
  DATABASE_URL: z.string().url(),
{{~/if}}
  DATA_DIR: z.string().default('./data'),
{{~/if}}

  // Server
  PORT: z.coerce.number().default(3000),
  LOG_LEVEL: z.enum(['silent', 'debug', 'info', 'warn', 'error']).default('info'),
})

export type Settings = z.infer<typeof envSchema>

function loadSettings(): Settings {
  const result = envSchema.safeParse(process.env)

  if (!result.success) {
    console.error('Invalid environment configuration:')
    for (const issue of result.error.issues) {
      console.error(`  ${issue.path.join('.')}: ${issue.message}`)
    }
    throw new Error('Failed to load settings. Check your environment variables.')
  }

  return result.data
}

export const settings = loadSettings()
{{~#if isAi}}

// Model helpers
function getModelForTier(tier: ModelTier) {
  const provider = settings.AI_PROVIDER
  const models = MODEL_TIERS[provider][tier]
  const modelId = models[0]!
{{~#if isOpenai}}
  return openai(modelId)
{{~/if}}
{{~#if isAnthropic}}
  return anthropic(modelId)
{{~/if}}
{{~#if isGoogle}}
  return google(modelId)
{{~/if}}
}

export function getModel() {
  return getModelForTier('default')
}

export function getFastModel() {
  return getModelForTier('fast')
}
{{~/if}}
