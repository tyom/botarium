import { drizzle } from 'drizzle-orm/bun-sqlite'
import { Database } from 'bun:sqlite'
import { existsSync, mkdirSync } from 'node:fs'
import { dirname, join } from 'node:path'
import { settings } from '../settings'
import * as schema from './schema'

const dbPath = join(settings.DATA_DIR, 'bot.sqlite')

// Ensure data directory exists
const dataDir = dirname(dbPath)
if (!existsSync(dataDir)) {
  mkdirSync(dataDir, { recursive: true })
}

const sqlite = new Database(dbPath)

// Create table if not exists
sqlite.run(`
  CREATE TABLE IF NOT EXISTS memory (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    team_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    content TEXT NOT NULL,
    type TEXT NOT NULL,
    category TEXT,
    source_channel TEXT,
    source_thread TEXT,
    created_at INTEGER
  )
`)

export const db = drizzle(sqlite, { schema })

export { schema }
